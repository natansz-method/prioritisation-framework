/*!
* 
*   @analytics-debugger/html-media-elements 0.0.2
*   https://github.com/analytics-debugger/html-media-elements-tracking-library
*
*   Copyright (c) David Vallejo (https://www.thyngster.com).
*   This source code is licensed under the MIT license found in the
*   LICENSE file in the root directory of this source tree.
*
*/

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self)._htmlMediaElementsTracker=e()}(this,(function(){"use strict";function t(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,r)}return a}function e(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?t(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):t(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function a(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function r(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var a=t&&("undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"]);if(null!=a){var r,n,o=[],c=!0,d=!1;try{for(a=a.call(t);!(c=(r=a.next()).done)&&(o.push(r.value),!e||o.length!==e);c=!0);}catch(t){d=!0,n=t}finally{try{c||null==a.return||a.return()}finally{if(d)throw n}}return o}}(t,e)||o(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(t){return function(t){if(Array.isArray(t))return c(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||o(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,e){if(t){if("string"==typeof t)return c(t,e);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?c(t,e):void 0}}function c(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,r=new Array(e);a<e;a++)r[a]=t[a];return r}var d=function(t){};return d.prototype={},d.init=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=e({tms:"debug",datalayerVariableNames:["auto"],debug:!1,observe:!1,data_elements:!1,start:!1,play:!1,pause:!1,mute:!1,unmute:!1,complete:!1,seek:!1,progress:!1,progress_tracking_method:"percentages",progress_percentages:[],progress_thresholds:[]},t),c=function(){o.debug&&Function.apply.call(console.log,console,arguments)};c("[ADSLU::DEBUG] - @analytics-debugger / HTML MEDIA ELEMENTS TRACKING",o),window.google_tag_manager&&o.tms.match(/gtm|gtag/)&&!o.dataLayer&&"auto"===o.datalayerVariableNames[0]&&(o.datalayerVariableNames=Object.entries(window.google_tag_manager).filter((function(t){return!!t[1].gtmDom&&t})).map((function(t){return t[0]}))),"auto"===o.datalayerVariableNames[0]&&(o.datalayerVariableNames=null);var d=function(t){var e=t.getBoundingClientRect();return!(e.top<0||e.left<0||e.bottom>(window.innerHeight||document.documentElement.clientHeight)||e.right>(window.innerWidth||document.documentElement.clientWidth))},i=function(t){var e="gtm"===o.tms?"gtm.":"";if(o[t["".concat(e).concat(t.elementNodeName,"Status")]])switch(o.tms){case"gtm":o.datalayerVariableNames?o.datalayerVariableNames.forEach((function(e){try{window[e].push(t)}catch(t){}})):o.debug&&c("[ADSLU::DEBUG] - Defined TMS not found");break;case"tealium":window.utag&&window.utag.link?window.utag.link(t):c("[ADSLU::DEBUG] - Defined TMS not found"),c("[ADSLU::DEBUG] - TEALIUM",t);break;case"debug":c("[ADSLU::DEBUG - HTML Element Event]",t)}},l=function(t){if(!t.getAttribute("data-html-media-element-tracked")){var e=Math.random().toString(36).slice(2);t.setAttribute("data-html-media-element-id",e),t.setAttribute("data-html-media-element-tracked",Math.round(1*new Date/1e3)),m[e]={progressMarkers:{},type:t.nodeName.toLowerCase(),greatest_marker:0,playEvent:!1,muted:!1,currentTime:0,state:"loaded",elapsedTime:0,lastUpdateTime:1*new Date,elementData:{}};var a=JSON.parse(JSON.stringify(t.dataset));for(var r in a){var n=r.match(/^htmlMediaElementParam(.+)/);n&&(m[e].elementData[n[1].toLowerCase()]=a[r])}"percentages"===o.progress_tracking_method&&o.progress_percentages.forEach((function(t){m[e].progressMarkers[t]=!1})),t.addEventListener("play",s,!1),t.addEventListener("pause",s,!1),t.addEventListener("ended",s,!1),t.addEventListener("timeupdate",s,!1),t.addEventListener("seeked",s,!1),t.addEventListener("volumechange",s,!1),t.addEventListener("error",s,!1)}},s=function(t){var e,n=t.target.nodeName.toLowerCase(),c="gtm"===o.tms?"gtm.":"",l=(a(e={event:"".concat(c).concat(n)},"".concat(c,"elementClasses"),t.target.className||""),a(e,"".concat(c,"elementId"),t.for||t.target.dataset.htmlMediaElementId||""),a(e,"".concat(c,"elementTarget"),t.target||""),a(e,"".concat(c,"element"),t.srcElement||""),a(e,"".concat(c,"elementUrl"),t.baseURI||document.location.href),a(e,"".concat(c).concat(n,"Provider"),"html5"),a(e,"".concat(c).concat(n,"Status"),t.type),a(e,"".concat(c).concat(n,"Url"),t.target.currentSrc),a(e,"".concat(c).concat(n,"Title"),t.target.getAttribute("data-html-media-element-title")&&o.data_elements?t.target.getAttribute("data-html-media-element-title"):decodeURIComponent(t.target.currentSrc.split("/")[t.target.currentSrc.split("/").length-1])),a(e,"".concat(c).concat(n,"Duration"),Math.round(t.target.duration)),a(e,"".concat(c).concat(n,"CurrentTime"),Math.round(t.target.currentTime)),a(e,"".concat(c).concat(n,"ElapsedTime"),Math.round(m[t.target.dataset.htmlMediaElementId].elapsedTime/1e3)),a(e,"".concat(c).concat(n,"Percent"),Math.floor(100*t.target.currentTime/t.target.duration)),a(e,"".concat(c).concat(n,"Visible"),d(t.target)),a(e,"".concat(c).concat(n,"IsMuted"),t.target.muted),a(e,"".concat(c).concat(n,"PlaybackRate"),t.target.playbackRate),a(e,"".concat(c).concat(n,"Loop"),t.target.loop),a(e,"".concat(c).concat(n,"Volume"),t.target.volume),a(e,"".concat(c).concat(n,"NetworkState"),t.target.networkState),a(e,"".concat(c).concat(n,"Data"),m[t.target.dataset.htmlMediaElementId].elementData),a(e,"elementNodeName",t.target.nodeName?t.target.nodeName.toLowerCase():"video"),e),s=!1;switch(t.type){case"volumechange":!0===l["".concat(c).concat(n,"IsMuted")]||0===l["".concat(c).concat(n,"Volume")]?(m[t.target.dataset.htmlMediaElementId].muted=!0,l["".concat(c).concat(n,"Status")]="mute"):!0===m[t.target.dataset.htmlMediaElementId].muted&&!1===l["".concat(c).concat(n,"IsMuted")]&&(m[t.target.dataset.htmlMediaElementId].muted=!1,l["".concat(c).concat(n,"Status")]="unmute");break;case"seeked":l["".concat(c).concat(n,"Status")]="seek",m[t.target.dataset.htmlMediaElementId].playEvent=!1;break;case"timeupdate":m[t.target.dataset.htmlMediaElementId].currentTime=Math.round(t.target.currentTime);var u=1*new Date;m[t.target.dataset.htmlMediaElementId].elapsedTime=m[t.target.dataset.htmlMediaElementId].elapsedTime+(u-m[t.target.dataset.htmlMediaElementId].lastUpdateTime),m[t.target.dataset.htmlMediaElementId].lastUpdateTime=u,Object.entries(m[t.target.dataset.htmlMediaElementId].progressMarkers).forEach((function(e){var a=r(e,1)[0];l["".concat(c).concat(n,"Percent")]>=a&&a>m[t.target.dataset.htmlMediaElementId].greatest_marker&&(m[t.target.dataset.htmlMediaElementId].greatest_marker=a)})),m[t.target.dataset.htmlMediaElementId].greatest_marker&&!m[t.target.dataset.htmlMediaElementId].progressMarkers[m[t.target.dataset.htmlMediaElementId].greatest_marker]&&(m[t.target.dataset.htmlMediaElementId].progressMarkers[m[t.target.dataset.htmlMediaElementId].greatest_marker]=!0,l["".concat(c).concat(n,"Status")]="progress",l["".concat(c).concat(n,"Percent")]=parseInt(m[t.target.dataset.htmlMediaElementId].greatest_marker));break;case"play":m[t.target.dataset.htmlMediaElementId].lastUpdateTime=1*new Date,"loaded"===m[t.target.dataset.htmlMediaElementId].state?(m[t.target.dataset.htmlMediaElementId].state="playing",l["".concat(c).concat(n,"Status")]="start"):s=!0;break;case"pause":m[t.target.dataset.htmlMediaElementId].state="paused",100!==l["".concat(c).concat(n,"Status")]&&!0!==t.target.seeking&&Math.round(t.target.currentTime)!==Math.round(t.target.duration)||(s=!0),m[t.target.dataset.htmlMediaElementId].playEvent=!0;break;case"ended":l["".concat(c).concat(n,"Status")]="complete",m[t.target.dataset.htmlMediaElementId].playEvent=!0;break;case"error":l["".concat(c).concat(n,"ErrorCode")]=t.target.error.code,l["".concat(c).concat(n,"ErrorMessage")]=t.target.error.message}s||i(l)},m={},u=[].concat(n(document.getElementsByTagName("audio")),n(document.getElementsByTagName("video")));if(c("[ADSLU::DEBUG] - FOUND ".concat(Object.keys(u).length," ELEMENTS"),u),u.forEach((function(t){l(t)})),o.observe&&(c("[ADSLU::DEBUG - OBSERVER ENABLED]"),window.MutationObserver)){var g=new MutationObserver((function(t){t.forEach((function(t){t.addedNodes.forEach((function(t){"VIDEO"===t.tagName&&(c("[NEW VIDEO::mutation]",t),l(t))}))}))}));g.observe(document.body,{attributes:!0,childList:!0,subtree:!0,characterData:!0})}},d}));
